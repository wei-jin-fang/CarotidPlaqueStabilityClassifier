# è®­ç»ƒä»£ç ä½¿ç”¨è¯´æ˜

## ğŸ¯ æ›´æ–°å†…å®¹

å·²å®Œæˆä»¥ä¸‹ä¿®æ”¹:

### âœ… 1. **æ•°æ®é›†åˆ’åˆ†æ”¹ä¸º 8:1:1**
- è®­ç»ƒé›†: 80%
- éªŒè¯é›†: 10%
- æµ‹è¯•é›†: 10%

### âœ… 2. **æ¯æ¬¡è®­ç»ƒè‡ªåŠ¨åˆ›å»ºç‹¬ç«‹æ–‡ä»¶å¤¹**
- æ ¼å¼: `train_YYYYMMDD_HHMMSS`
- ä¾‹å¦‚: `train_20250105_143025`

### âœ… 3. **å®Œæ•´çš„è®­ç»ƒææ–™ä¿å­˜**

æ¯æ¬¡è®­ç»ƒä¼šä¿å­˜ä»¥ä¸‹æ‰€æœ‰å†…å®¹:

```
train_20250105_143025/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ best_model.pth         # éªŒè¯é›†ä¸Šè¡¨ç°æœ€å¥½çš„æ¨¡å‹
â”‚   â””â”€â”€ final_model.pth        # æœ€åä¸€ä¸ª epoch çš„æ¨¡å‹
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ config.json            # è®­ç»ƒé…ç½®å‚æ•°
â”‚   â”œâ”€â”€ data_split.json        # æ•°æ®é›†åˆ’åˆ†ç´¢å¼•
â”‚   â”œâ”€â”€ training_history.csv   # è®­ç»ƒå†å² (CSV æ ¼å¼)
â”‚   â””â”€â”€ training_history.json  # è®­ç»ƒå†å² (JSON æ ¼å¼)
â”œâ”€â”€ plots/
â”‚   â””â”€â”€ training_curves.png    # è®­ç»ƒæ›²çº¿ (4åˆ1å›¾è¡¨)
â”œâ”€â”€ test_results/
â”‚   â”œâ”€â”€ confusion_matrix.png   # æ··æ·†çŸ©é˜µ
â”‚   â”œâ”€â”€ roc_curve.png          # ROC æ›²çº¿
â”‚   â”œâ”€â”€ metrics_bar.png        # æŒ‡æ ‡æŸ±çŠ¶å›¾
â”‚   â”œâ”€â”€ probability_distribution.png  # æ¦‚ç‡åˆ†å¸ƒ
â”‚   â”œâ”€â”€ detailed_results.csv   # è¯¦ç»†é¢„æµ‹ç»“æœ
â”‚   â””â”€â”€ metrics_summary.txt    # æµ‹è¯•æŒ‡æ ‡æ‘˜è¦
â”œâ”€â”€ gradcam/                   # GradCAM å¯è§†åŒ– (å¦‚æœå¯ç”¨)
â””â”€â”€ final_results.json         # æœ€ç»ˆç»“æœæ‘˜è¦
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ä½¿ç”¨

```bash
python train_gradcam.py
```

ç¨‹åºä¼šè‡ªåŠ¨:
1. åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„è®­ç»ƒæ–‡ä»¶å¤¹
2. åŠ è½½æ•°æ®é›†å¹¶æŒ‰ 8:1:1 åˆ’åˆ†
3. è®­ç»ƒæ¨¡å‹
4. åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°
5. ä¿å­˜æ‰€æœ‰è®­ç»ƒææ–™

### 2. ä¿®æ”¹é…ç½®

åœ¨ä»£ç çš„ `CONFIG` å­—å…¸ä¸­ä¿®æ”¹å‚æ•°:

```python
CONFIG = {
    # æ•°æ®é…ç½®
    'root_dir': "./data",              # æ•°æ®ç›®å½•
    'label_excel': "./label.xlsx",     # æ ‡ç­¾æ–‡ä»¶
    'class_names': ['Cat', 'Dog'],     # ç±»åˆ«åç§°

    # è®­ç»ƒé…ç½®
    'batch_size': 8,                   # æ‰¹æ¬¡å¤§å°
    'epochs': 50,                      # è®­ç»ƒè½®æ•°
    'learning_rate': 1e-4,             # å­¦ä¹ ç‡
    'max_imgs_per_person': 1000,       # æ¯äººæœ€å¤šå›¾ç‰‡æ•°

    # æ•°æ®åˆ’åˆ†
    'train_ratio': 0.8,                # è®­ç»ƒé›†æ¯”ä¾‹
    'val_ratio': 0.1,                  # éªŒè¯é›†æ¯”ä¾‹
    'test_ratio': 0.1,                 # æµ‹è¯•é›†æ¯”ä¾‹

    # å…¶ä»–
    'random_seed': 42,                 # éšæœºç§å­
    'device': 'cuda' if torch.cuda.is_available() else 'cpu'
}
```

---

## ğŸ“Š è®­ç»ƒè¾“å‡ºç¤ºä¾‹

### æ§åˆ¶å°è¾“å‡º

```
============================================================
è®­ç»ƒé…ç½®
============================================================
  root_dir: ./data
  label_excel: ./label.xlsx
  class_names: ['Cat', 'Dog']
  batch_size: 8
  epochs: 50
  learning_rate: 0.0001
  train_ratio: 0.8
  val_ratio: 0.1
  test_ratio: 0.1
  random_seed: 42
  device: cuda
============================================================

============================================================
åˆ›å»ºè®­ç»ƒæ–‡ä»¶å¤¹: train_20250105_143025
============================================================
  - æ¨¡å‹ä¿å­˜: train_20250105_143025/models
  - è®­ç»ƒæ—¥å¿—: train_20250105_143025/logs
  - æµ‹è¯•ç»“æœ: train_20250105_143025/test_results
  - GradCAM: train_20250105_143025/gradcam
  - å›¾è¡¨: train_20250105_143025/plots
============================================================

âœ“ è®­ç»ƒé…ç½®å·²ä¿å­˜: train_20250105_143025/logs/config.json

åŠ è½½æ•°æ®é›†...
Loaded 10 persons.
Total images: 1500
============================================================
  cat1      :  150 å¼  | Label: 0
  cat2      :  145 å¼  | Label: 0
  ...
============================================================

æ•°æ®é›†åˆ’åˆ† (Train:Val:Test = 8:1:1)...
  è®­ç»ƒé›†: 8 ä¸ªæ ·æœ¬
  éªŒè¯é›†: 1 ä¸ªæ ·æœ¬
  æµ‹è¯•é›†: 1 ä¸ªæ ·æœ¬
  æ€»è®¡:   10 ä¸ªæ ·æœ¬

âœ“ æ•°æ®åˆ’åˆ†ä¿¡æ¯å·²ä¿å­˜: train_20250105_143025/logs/data_split.json

åˆ›å»ºæ¨¡å‹...
âœ“ æ¨¡å‹å·²åŠ è½½åˆ°è®¾å¤‡: cuda

============================================================
å¼€å§‹è®­ç»ƒ...
============================================================
Epoch  1/50 | Train Loss: 0.6234 | Val Loss: 0.5123 | Val Acc: 0.7500 | LR: 0.000100
Epoch  2/50 | Train Loss: 0.4567 | Val Loss: 0.3891 | Val Acc: 0.8750 | LR: 0.000098
  â†’ ä¿å­˜æœ€ä½³æ¨¡å‹ (Val Acc: 0.8750)
Epoch  3/50 | Train Loss: 0.3234 | Val Loss: 0.2456 | Val Acc: 0.9375 | LR: 0.000095
  â†’ ä¿å­˜æœ€ä½³æ¨¡å‹ (Val Acc: 0.9375)
...
============================================================
è®­ç»ƒå®Œæˆ! æœ€ä½³éªŒè¯å‡†ç¡®ç‡: 0.9375 (Epoch 28)
============================================================

âœ“ è®­ç»ƒå†å²å·²ä¿å­˜: train_20250105_143025/logs/training_history.csv
âœ“ è®­ç»ƒæ›²çº¿å·²ä¿å­˜: train_20250105_143025/plots/training_curves.png
âœ“ æœ€ç»ˆæ¨¡å‹å·²ä¿å­˜: train_20250105_143025/models/final_model.pth

============================================================
åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°æœ€ä½³æ¨¡å‹...
============================================================

âœ“ å·²åŠ è½½æœ€ä½³æ¨¡å‹: train_20250105_143025/models/best_model.pth

============================================================
å¼€å§‹æµ‹è¯•é›†è¯„ä¼°...
============================================================

============================================================
æµ‹è¯•é›†è¯„ä¼°ç»“æœ
============================================================
æ€»æ ·æœ¬æ•°: 1
ç±»åˆ«åˆ†å¸ƒ: Cat=0, Dog=1
------------------------------------------------------------
å‡†ç¡®ç‡ (Accuracy):  1.0000 (100.00%)
ç²¾ç¡®ç‡ (Precision): 1.0000
å¬å›ç‡ (Recall):    1.0000
F1 åˆ†æ•° (F1-Score): 1.0000
AUC-ROC:           1.0000
============================================================

âœ“ æ··æ·†çŸ©é˜µå·²ä¿å­˜: train_20250105_143025/test_results/confusion_matrix.png
âœ“ ROC æ›²çº¿å·²ä¿å­˜: train_20250105_143025/test_results/roc_curve.png
âœ“ æŒ‡æ ‡æŸ±çŠ¶å›¾å·²ä¿å­˜: train_20250105_143025/test_results/metrics_bar.png
âœ“ æ¦‚ç‡åˆ†å¸ƒå›¾å·²ä¿å­˜: train_20250105_143025/test_results/probability_distribution.png
âœ“ è¯¦ç»†ç»“æœå·²ä¿å­˜: train_20250105_143025/test_results/detailed_results.csv
âœ“ æŒ‡æ ‡æ‘˜è¦å·²ä¿å­˜: train_20250105_143025/test_results/metrics_summary.txt

============================================================
æ‰€æœ‰ç»“æœå·²ä¿å­˜åˆ°ç›®å½•: train_20250105_143025/test_results
============================================================

============================================================
æœ€ç»ˆç»“æœæ‘˜è¦
============================================================
  æœ€ä½³éªŒè¯å‡†ç¡®ç‡: 0.9375
  æµ‹è¯•é›†å‡†ç¡®ç‡:   1.0000
  æµ‹è¯•é›† F1:      1.0000
  æµ‹è¯•é›† AUC:     1.0000
============================================================

âœ“ æ‰€æœ‰è®­ç»ƒææ–™å·²ä¿å­˜åˆ°: train_20250105_143025
============================================================
```

---

## ğŸ“ æ–‡ä»¶è¯¦ç»†è¯´æ˜

### 1. **æ¨¡å‹æ–‡ä»¶** (`models/`)

| æ–‡ä»¶ | è¯´æ˜ | ä½•æ—¶ä½¿ç”¨ |
|------|------|---------|
| `best_model.pth` | éªŒè¯é›†ä¸Šå‡†ç¡®ç‡æœ€é«˜çš„æ¨¡å‹ | **æ¨èç”¨äºæ¨ç†** |
| `final_model.pth` | æœ€åä¸€ä¸ª epoch çš„æ¨¡å‹ | ç»§ç»­è®­ç»ƒæˆ–ç ”ç©¶è¿‡æ‹Ÿåˆ |

### 2. **æ—¥å¿—æ–‡ä»¶** (`logs/`)

#### `config.json`
```json
{
    "root_dir": "./data",
    "label_excel": "./label.xlsx",
    "class_names": ["Cat", "Dog"],
    "batch_size": 8,
    "epochs": 50,
    "learning_rate": 0.0001,
    ...
}
```

#### `data_split.json`
```json
{
    "train_indices": [0, 3, 5, 7, 8, 9, 2, 4],
    "val_indices": [1],
    "test_indices": [6],
    "train_size": 8,
    "val_size": 1,
    "test_size": 1
}
```

#### `training_history.csv`
```csv
train_loss,val_acc,val_loss,learning_rate,epoch
0.6234,0.7500,0.5123,0.000100,1
0.4567,0.8750,0.3891,0.000098,2
...
```

### 3. **å›¾è¡¨æ–‡ä»¶** (`plots/`)

#### `training_curves.png`
åŒ…å« 4 ä¸ªå­å›¾:
1. **è®­ç»ƒ/éªŒè¯æŸå¤±æ›²çº¿**
2. **éªŒè¯å‡†ç¡®ç‡æ›²çº¿**
3. **å­¦ä¹ ç‡å˜åŒ–æ›²çº¿**
4. **æŸå¤± vs å‡†ç¡®ç‡æ•£ç‚¹å›¾**

### 4. **æµ‹è¯•ç»“æœ** (`test_results/`)

æ‰€æœ‰æµ‹è¯•é›†ä¸Šçš„è¯„ä¼°ç»“æœ,è¯¦è§ä¹‹å‰çš„æµ‹è¯•è¯„ä¼°æ–‡æ¡£ã€‚

### 5. **æœ€ç»ˆç»“æœ** (`final_results.json`)

```json
{
    "best_val_acc": 0.9375,
    "test_accuracy": 1.0,
    "test_precision": 1.0,
    "test_recall": 1.0,
    "test_f1": 1.0,
    "test_auc": 1.0,
    "training_epochs": 50,
    "device": "cuda"
}
```

---

## ğŸ”§ å¸¸è§ä»»åŠ¡

### ä»»åŠ¡ 1: åŠ è½½ä¿å­˜çš„æ¨¡å‹è¿›è¡Œæ¨ç†

```python
import torch
from train_gradcam import ResNetAttentionFusion

# åŠ è½½æ¨¡å‹
model = ResNetAttentionFusion(pretrained=False, num_classes=2)
model.load_state_dict(torch.load('train_20250105_143025/models/best_model.pth'))
model.eval()

# æ¨ç†
# ... (ä½ çš„æ¨ç†ä»£ç )
```

### ä»»åŠ¡ 2: æŸ¥çœ‹è®­ç»ƒæ›²çº¿

```python
import pandas as pd
import matplotlib.pyplot as plt

# è¯»å–è®­ç»ƒå†å²
df = pd.read_csv('train_20250105_143025/logs/training_history.csv')

# ç»˜åˆ¶è‡ªå®šä¹‰æ›²çº¿
plt.plot(df['epoch'], df['train_loss'], label='Train Loss')
plt.plot(df['epoch'], df['val_loss'], label='Val Loss')
plt.legend()
plt.show()
```

### ä»»åŠ¡ 3: åˆ†æé¢„æµ‹é”™è¯¯çš„æ ·æœ¬

```python
import pandas as pd

# è¯»å–è¯¦ç»†ç»“æœ
df = pd.read_csv('train_20250105_143025/test_results/detailed_results.csv')

# æ‰¾å‡ºé¢„æµ‹é”™è¯¯çš„æ ·æœ¬
errors = df[df['Correct'] == False]
print(f"é”™è¯¯æ ·æœ¬æ•°: {len(errors)}")
print(errors)
```

### ä»»åŠ¡ 4: å¤ç°æŸæ¬¡å®éªŒ

```python
import json

# è¯»å–é…ç½®
with open('train_20250105_143025/logs/config.json', 'r') as f:
    config = json.load(f)

# è¯»å–æ•°æ®åˆ’åˆ†
with open('train_20250105_143025/logs/data_split.json', 'r') as f:
    split = json.load(f)

# ä½¿ç”¨ç›¸åŒé…ç½®å’Œåˆ’åˆ†é‡æ–°è®­ç»ƒ
# ... (è®¾ç½®ç›¸åŒçš„å‚æ•°å’Œç´¢å¼•)
```

---

## ğŸ¯ æ•°æ®é›†åˆ’åˆ†è¯´æ˜

### ä¸ºä»€ä¹ˆæ˜¯ 8:1:1?

| é›†åˆ | æ¯”ä¾‹ | ç”¨é€” | è¯´æ˜ |
|------|------|------|------|
| **è®­ç»ƒé›†** | 80% | æ›´æ–°æ¨¡å‹å‚æ•° | æ•°æ®é‡è¶Šå¤§,æ¨¡å‹å­¦ä¹ è¶Šå……åˆ† |
| **éªŒè¯é›†** | 10% | é€‰æ‹©æœ€ä½³æ¨¡å‹ã€è°ƒæ•´è¶…å‚æ•° | ç”¨äºæ—©åœã€ä¿å­˜æœ€ä½³æ¨¡å‹ |
| **æµ‹è¯•é›†** | 10% | æœ€ç»ˆæ€§èƒ½è¯„ä¼° | **å®Œå…¨ç‹¬ç«‹**,è®­ç»ƒæ—¶ä»æœªè§è¿‡ |

### åˆ’åˆ†ç‰¹ç‚¹

- âœ… **å›ºå®šéšæœºç§å­** (`random_seed=42`): ç¡®ä¿å¯å¤ç°
- âœ… **ä¿å­˜åˆ’åˆ†ç´¢å¼•**: å¯ä»¥å‡†ç¡®å¤ç°æ•°æ®åˆ’åˆ†
- âœ… **å®Œå…¨ç‹¬ç«‹**: ä¸‰ä¸ªé›†åˆæ²¡æœ‰é‡å 

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç¡®ä¿æ•°æ®ç›®å½•æ­£ç¡®

```python
CONFIG = {
    'root_dir': "./data",          # ä¿®æ”¹ä¸ºä½ çš„æ•°æ®ç›®å½•
    'label_excel': "./label.xlsx",  # ä¿®æ”¹ä¸ºä½ çš„æ ‡ç­¾æ–‡ä»¶
    ...
}
```

### 2. ç±»åˆ«åç§°è¦å¯¹åº”

```python
CONFIG = {
    'class_names': ['Cat', 'Dog'],  # 0å¯¹åº”Cat, 1å¯¹åº”Dog
    ...
}
```

### 3. ç£ç›˜ç©ºé—´

æ¯æ¬¡è®­ç»ƒä¼šç”Ÿæˆä¸€ä¸ªæ–°æ–‡ä»¶å¤¹,ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´:
- æ¨¡å‹æ–‡ä»¶: ~50MB (æ¯ä¸ª)
- å›¾è¡¨: ~10MB
- CSV: ~1MB
- æ€»è®¡: ~100-200MB/æ¬¡è®­ç»ƒ

### 4. GPU æ˜¾å­˜

å¦‚æœæ˜¾å­˜ä¸è¶³,è°ƒæ•´:
```python
CONFIG = {
    'batch_size': 4,  # é™ä½æ‰¹æ¬¡å¤§å°
    'max_imgs_per_person': 500,  # å‡å°‘æ¯äººå›¾ç‰‡æ•°
    ...
}
```

---

## ğŸ“Š ä¸æ—§ç‰ˆæœ¬çš„å¯¹æ¯”

| åŠŸèƒ½ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|------|--------|--------|
| æ•°æ®åˆ’åˆ† | 8:2 (train:val) | 8:1:1 (train:val:test) |
| æ–‡ä»¶ä¿å­˜ | å½“å‰ç›®å½•æ•£ä¹± | ç‹¬ç«‹æ—¶é—´æˆ³æ–‡ä»¶å¤¹ |
| è®­ç»ƒå†å² | æ—  | CSV + JSON + æ›²çº¿å›¾ |
| æ¨¡å‹ä¿å­˜ | å•ä¸ªæ–‡ä»¶ | best + final ä¸¤ä¸ª |
| é…ç½®ä¿å­˜ | æ—  | config.json |
| æ•°æ®åˆ’åˆ†è®°å½• | æ—  | data_split.json |
| æµ‹è¯•é›†è¯„ä¼° | æ—  | å®Œæ•´è¯„ä¼° + å¯è§†åŒ– |
| ç»“æœæ‘˜è¦ | æ—  | final_results.json |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# 1. ç¡®ä¿æ•°æ®å’Œæ ‡ç­¾æ–‡ä»¶å°±ç»ª
ls ./data
ls ./label.xlsx

# 2. ä¿®æ”¹é…ç½® (å¯é€‰)
# ç¼–è¾‘ train_gradcam.py ä¸­çš„ CONFIG å­—å…¸

# 3. å¼€å§‹è®­ç»ƒ
python train_gradcam.py

# 4. æŸ¥çœ‹ç»“æœ
ls train_*/  # æŸ¥çœ‹ç”Ÿæˆçš„è®­ç»ƒæ–‡ä»¶å¤¹
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•åªè¯„ä¼°ä¸è®­ç»ƒ?

A: åœ¨ä»£ç ä¸­æ³¨é‡Šè®­ç»ƒéƒ¨åˆ†:
```python
# history, best_val_acc = train_model(...)  # æ³¨é‡Šè¿™è¡Œ

# æ‰‹åŠ¨æŒ‡å®šå·²æœ‰æ¨¡å‹
best_model_path = "train_20250105_143025/models/best_model.pth"
```

### Q2: å¦‚ä½•ä¿®æ”¹æ•°æ®åˆ’åˆ†æ¯”ä¾‹?

A: ä¿®æ”¹ CONFIG:
```python
CONFIG = {
    'train_ratio': 0.7,   # 70%
    'val_ratio': 0.15,    # 15%
    'test_ratio': 0.15,   # 15%
    ...
}
```

### Q3: æ–‡ä»¶å¤¹å‘½åèƒ½è‡ªå®šä¹‰å—?

A: ä¿®æ”¹ `create_training_folder()` å‡½æ•°:
```python
def create_training_folder(base_dir=".", exp_name=None):
    if exp_name is None:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        exp_name = f"train_{timestamp}"
    # ...
```

### Q4: å¦‚ä½•å¯ç”¨ GradCAM å¯è§†åŒ–?

A: å–æ¶ˆä¸»ç¨‹åºæœ€åçš„æ³¨é‡Š:
```python
# åœ¨ä¸»ç¨‹åºæœ«å°¾
test_person = "dog1"
predict_and_visualize(model, full_dataset, test_person, DEVICE, max_vis=3)
```

---

## âœ… æ€»ç»“

ç°åœ¨æ¯æ¬¡è®­ç»ƒéƒ½ä¼š:
1. âœ… è‡ªåŠ¨åˆ›å»ºç‹¬ç«‹çš„æ—¶é—´æˆ³æ–‡ä»¶å¤¹
2. âœ… æ•°æ®é›†æŒ‰ 8:1:1 åˆ’åˆ†
3. âœ… ä¿å­˜æ‰€æœ‰è®­ç»ƒææ–™(æ¨¡å‹ã€æ—¥å¿—ã€å›¾è¡¨ã€æµ‹è¯•ç»“æœ)
4. âœ… ç”Ÿæˆå®Œæ•´çš„è®­ç»ƒæ›²çº¿å’Œæµ‹è¯•è¯„ä¼°æŠ¥å‘Š
5. âœ… è®°å½•æ‰€æœ‰é…ç½®å’Œæ•°æ®åˆ’åˆ†,å®Œå…¨å¯å¤ç°

æ‰€æœ‰è®­ç»ƒææ–™äº•ç„¶æœ‰åº,æ˜“äºç®¡ç†å’Œåˆ†æ! ğŸ‰
